---
// ABOUTME: Supply Chain Security Analysis page with interactive charts and maturity framework
// ABOUTME: Presents 2025 threat landscape data with Chart.js visualizations
import Layout from "~/layouts/PageLayout.astro";
import CallToAction from "~/components/widgets/CallToAction.astro";
import type { MetaData } from "~/types";
import { t, changeLanguage } from "i18next";
import { getPagePermalink } from "~/utils/permalinks";

changeLanguage("en");

const metadata: MetaData = {
    title: t("supply-chain.metadata.title"),
    description: t("supply-chain.metadata.description")
};
---

<Layout metadata={metadata}>
    <div class="container mx-auto px-4 md:px-8 py-12">
        <header class="text-center mb-16">
            <h1 class="text-4xl md:text-6xl font-black text-default mb-4">{t("supply-chain.hero.title")}</h1>
            <h2 class="text-2xl md:text-3xl font-bold text-accent mb-6">{t("supply-chain.hero.subtitle")}</h2>
            <p class="max-w-3xl mx-auto mt-4 text-lg text-muted">
                {t("supply-chain.hero.description")}
            </p>
        </header>

        <section id="threat-landscape" class="mb-20">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <div
                    class="kpi-card rounded-lg shadow-xl p-6 flex flex-col justify-center items-center bg-page border-l-4 border-accent h-full"
                >
                    <div class="text-6xl font-black text-default">{t("supply-chain.kpis.cost.value")}</div>
                    <div class="text-lg text-accent mt-2 text-center">
                        {t("supply-chain.kpis.cost.label")}
                    </div>
                </div>
                <div
                    class="kpi-card rounded-lg shadow-xl p-6 flex flex-col justify-center items-center bg-page border-l-4 border-accent h-full"
                >
                    <div class="text-6xl font-black text-default">45%</div>
                    <div class="text-lg text-accent mt-2 text-center">
                        {t("supply-chain.kpis.organizations.label")}
                    </div>
                </div>
                <div
                    class="kpi-card rounded-lg shadow-xl p-6 flex flex-col justify-center items-center bg-page border-l-4 border-accent h-full"
                >
                    <div class="text-6xl font-black text-default">~2x</div>
                    <div class="text-lg text-accent mt-2 text-center">
                        {t("supply-chain.kpis.increase.label")}
                    </div>
                </div>
            </div>
        </section>

        <section id="key-incidents" class="mb-20">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 items-stretch">
                <div class="bg-page dark:bg-slate-800 rounded-lg shadow-xl p-8 flex flex-col">
                    <h3 class="text-3xl font-bold text-default mb-6">{t("supply-chain.incidents.title")}</h3>
                    <p class="mb-6 text-lg text-muted">
                        {t("supply-chain.incidents.description")}
                    </p>
                    <div class="relative pl-12 border-l-2 border-dashed border-muted/30 flex-grow">
                        <div class="timeline-item relative mb-8">
                            <h4 class="font-bold text-accent">2020: SolarWinds</h4>
                            <p class="text-sm text-muted">
                                {t("supply-chain.incidents.timeline.2020.description")}
                            </p>
                        </div>
                        <div class="timeline-item relative mb-8">
                            <h4 class="font-bold text-accent">2023: 3CX Desktop App</h4>
                            <p class="text-sm text-muted">
                                {t("supply-chain.incidents.timeline.2023.description")}
                            </p>
                        </div>
                        <div class="timeline-item relative mb-8">
                            <h4 class="font-bold text-accent">2024: XZ Utils & Polyfill.io</h4>
                            <p class="text-sm text-muted">
                                {t("supply-chain.incidents.timeline.2024.description")}
                            </p>
                        </div>
                        <div class="timeline-item relative">
                            <h4 class="font-bold text-accent">2025: Red Hat GitLab & Hugging Face</h4>
                            <p class="text-sm text-muted">
                                {t("supply-chain.incidents.timeline.2025.description")}
                            </p>
                        </div>
                    </div>
                </div>
                <div class="bg-page dark:bg-slate-800 rounded-lg shadow-xl p-8 flex flex-col">
                    <h3 class="text-3xl font-bold text-default mb-4 text-center">
                        {t("supply-chain.incidents.chart.title")}
                    </h3>
                    <p class="text-center mb-4 text-muted">
                        {t("supply-chain.incidents.chart.description")}
                    </p>
                    <div class="chart-container h-[400px] flex-grow">
                        <canvas id="attackTrendChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <section id="risk-vectors" class="mb-20">
            <h3 class="text-4xl font-bold text-default text-center mb-4">
                {t("supply-chain.risks.title")}
            </h3>
            <p class="text-xl text-center max-w-4xl mx-auto mb-12 text-muted">
                {t("supply-chain.risks.description")}
            </p>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 items-stretch">
                <div class="bg-page dark:bg-slate-800 rounded-lg shadow-xl p-6 flex flex-col h-full">
                    <div class="text-4xl mb-3">üîë</div>
                    <h4 class="text-xl font-bold text-default mb-2">Credential & Secret Leakage</h4>
                    <p class="text-muted flex-grow">
                        {t("supply-chain.risks.credentials.description")}
                    </p>
                </div>
                <div class="bg-page dark:bg-slate-800 rounded-lg shadow-xl p-6 flex flex-col h-full">
                    <div class="text-4xl mb-3">üì¶</div>
                    <h4 class="text-xl font-bold text-default mb-2">{t("supply-chain.risks.dependencies.title")}</h4>
                    <p class="text-muted flex-grow">
                        {t("supply-chain.risks.dependencies.description")}
                    </p>
                </div>
                <div class="bg-page dark:bg-slate-800 rounded-lg shadow-xl p-6 flex flex-col h-full">
                    <div class="text-4xl mb-3">üõ†Ô∏è</div>
                    <h4 class="text-xl font-bold text-default mb-2">Poisoned Pipeline Execution</h4>
                    <p class="text-muted flex-grow">
                        {t("supply-chain.risks.pipeline.description")}
                    </p>
                </div>
                <div class="bg-page dark:bg-slate-800 rounded-lg shadow-xl p-6 flex flex-col h-full">
                    <div class="text-4xl mb-3">üõ°Ô∏è</div>
                    <h4 class="text-xl font-bold text-default mb-2">Artifact Tampering</h4>
                    <p class="text-muted flex-grow">
                        {t("supply-chain.risks.artifacts.description")}
                    </p>
                </div>
                <div class="bg-page dark:bg-slate-800 rounded-lg shadow-xl p-6 flex flex-col h-full">
                    <div class="text-4xl mb-3">üì§</div>
                    <h4 class="text-xl font-bold text-default mb-2">{t("supply-chain.risks.exfiltration.title")}</h4>
                    <p class="text-muted flex-grow">
                        {t("supply-chain.risks.exfiltration.description")}
                    </p>
                </div>
                <div class="bg-page dark:bg-slate-800 rounded-lg shadow-xl p-6 flex flex-col h-full">
                    <div class="text-4xl mb-3">üß†</div>
                    <h4 class="text-xl font-bold text-default mb-2">{t("supply-chain.risks.aiml.title")}</h4>
                    <p class="text-muted flex-grow">
                        {t("supply-chain.risks.aiml.description")}
                    </p>
                </div>
            </div>
        </section>

        <section id="maturity-model" class="mb-20">
            <h3 class="text-4xl font-bold text-default text-center mb-4">{t("supply-chain.maturity.title")}</h3>
            <p class="text-xl text-center max-w-4xl mx-auto mb-12 text-muted">
                {t("supply-chain.maturity.description")}
            </p>
            <div class="flex flex-col md:flex-row items-stretch justify-center space-y-8 md:space-y-0 md:space-x-4">
                <div
                    class="bg-page dark:bg-slate-800 rounded-lg shadow-xl p-6 text-center w-full md:w-1/4 flex flex-col"
                >
                    <div class="text-2xl font-bold text-accent mb-2">Level 1</div>
                    <h4 class="text-xl font-bold text-default mb-2">{t("supply-chain.maturity.level1.title")}</h4>
                    <p class="text-sm text-muted flex-grow">
                        {t("supply-chain.maturity.level1.description")}
                    </p>
                </div>
                <div class="flow-arrow hidden md:flex items-center text-accent text-2xl">‚Üí</div>
                <div
                    class="bg-page dark:bg-slate-800 rounded-lg shadow-xl p-6 text-center w-full md:w-1/4 flex flex-col"
                >
                    <div class="text-2xl font-bold text-accent mb-2">Level 2</div>
                    <h4 class="text-xl font-bold text-default mb-2">{t("supply-chain.maturity.level2.title")}</h4>
                    <p class="text-sm text-muted flex-grow">
                        {t("supply-chain.maturity.level2.description")}
                    </p>
                </div>
                <div class="flow-arrow hidden md:flex items-center text-accent text-2xl">‚Üí</div>
                <div
                    class="bg-page dark:bg-slate-800 rounded-lg shadow-xl p-6 text-center w-full md:w-1/4 flex flex-col"
                >
                    <div class="text-2xl font-bold text-accent mb-2">Level 3</div>
                    <h4 class="text-xl font-bold text-default mb-2">{t("supply-chain.maturity.level3.title")}</h4>
                    <p class="text-sm text-muted flex-grow">
                        {t("supply-chain.maturity.level3.description")}
                    </p>
                </div>
                <div class="flow-arrow hidden md:flex items-center text-accent text-2xl">‚Üí</div>
                <div
                    class="bg-page dark:bg-slate-800 rounded-lg shadow-xl p-6 text-center w-full md:w-1/4 flex flex-col"
                >
                    <div class="text-2xl font-bold text-accent mb-2">Level 4</div>
                    <h4 class="text-xl font-bold text-default mb-2">{t("supply-chain.maturity.level4.title")}</h4>
                    <p class="text-sm text-muted flex-grow">
                        {t("supply-chain.maturity.level4.description")}
                    </p>
                </div>
            </div>
        </section>

        <section id="compliance" class="mb-16">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 items-stretch">
                <div class="bg-page dark:bg-slate-800 rounded-lg shadow-xl p-8 flex flex-col">
                    <h3 class="text-3xl font-bold text-default mb-4 text-center">
                        {t("supply-chain.compliance.gartner.title")}
                    </h3>
                    <p class="text-center mb-4 text-muted">
                        {t("supply-chain.compliance.gartner.description")}
                    </p>
                    <div class="chart-container flex-grow">
                        <canvas id="gartnerPredictionChart"></canvas>
                    </div>
                </div>
                <div class="bg-page dark:bg-slate-800 rounded-lg shadow-xl p-8 flex flex-col">
                    <h3 class="text-3xl font-bold text-default mb-6">{t("supply-chain.compliance.mapping.title")}</h3>
                    <p class="mb-6 text-lg text-muted">
                        {t("supply-chain.compliance.mapping.description")}
                    </p>
                    <div class="flex-grow">
                        <div class="mb-6">
                            <h4 class="text-xl font-bold text-accent mb-2">EU Cyber Resilience Act (CRA)</h4>
                            <p class="mb-2 text-muted">
                                {t("supply-chain.compliance.mapping.cra.description")}
                            </p>
                            <ul class="list-disc list-inside text-sm space-y-1 text-muted">
                                <li>
                                    <span class="font-semibold text-default">Level 2:</span>
                                    {t("supply-chain.compliance.mapping.cra.level2")}
                                </li>
                                <li>
                                    <span class="font-semibold text-default">Level 3:</span>
                                    {t("supply-chain.compliance.mapping.cra.level3")}
                                </li>
                                <li>
                                    <span class="font-semibold text-default">Level 4:</span>
                                    {t("supply-chain.compliance.mapping.cra.level4")}
                                </li>
                            </ul>
                        </div>
                        <div>
                            <h4 class="text-xl font-bold text-accent mb-2">
                                {t("supply-chain.compliance.mapping.nis2.title")}
                            </h4>
                            <p class="mb-2 text-muted">
                                {t("supply-chain.compliance.mapping.nis2.description")}
                            </p>
                            <ul class="list-disc list-inside text-sm space-y-1 text-muted">
                                <li>
                                    <span class="font-semibold text-default">Level 3:</span>
                                    {t("supply-chain.compliance.mapping.nis2.level3")}
                                </li>
                                <li>
                                    <span class="font-semibold text-default">Level 4:</span>
                                    {t("supply-chain.compliance.mapping.nis2.level4")}
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="our-services" class="mb-20">
            <h3 class="text-4xl font-bold text-default text-center mb-4">
                {t("supply-chain.services.title")}
            </h3>
            <p class="text-xl text-center max-w-4xl mx-auto mb-12 text-muted">
                {t("supply-chain.services.description")}
            </p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-stretch">
                <div class="bg-page dark:bg-slate-800 rounded-lg shadow-xl p-8 flex flex-col h-full">
                    <div class="text-5xl mb-4 text-center">üìä</div>
                    <h4 class="text-2xl font-bold text-accent mb-3 text-center">
                        {t("supply-chain.services.assessment.title")}
                    </h4>
                    <p class="text-muted flex-grow">
                        {t("supply-chain.services.assessment.description")}
                    </p>
                </div>
                <div class="bg-page dark:bg-slate-800 rounded-lg shadow-xl p-8 flex flex-col h-full">
                    <div class="text-5xl mb-4 text-center">üîí</div>
                    <h4 class="text-2xl font-bold text-accent mb-3 text-center">
                        {t("supply-chain.services.hardening.title")}
                    </h4>
                    <p class="text-muted flex-grow">
                        {t("supply-chain.services.hardening.description")}
                    </p>
                </div>
                <div class="bg-page dark:bg-slate-800 rounded-lg shadow-xl p-8 flex flex-col h-full">
                    <div class="text-5xl mb-4 text-center">‚úçÔ∏è</div>
                    <h4 class="text-2xl font-bold text-accent mb-3 text-center">
                        {t("supply-chain.services.builds.title")}
                    </h4>
                    <p class="text-muted flex-grow">
                        {t("supply-chain.services.builds.description")}
                    </p>
                </div>
                <div class="bg-page dark:bg-slate-800 rounded-lg shadow-xl p-8 flex flex-col h-full">
                    <div class="text-5xl mb-4 text-center">üì¶</div>
                    <h4 class="text-2xl font-bold text-accent mb-3 text-center">
                        {t("supply-chain.services.containers.title")}
                    </h4>
                    <p class="text-muted flex-grow">
                        {t("supply-chain.services.containers.description")}
                    </p>
                </div>
            </div>
        </section>
    </div>

    <CallToAction
        title={t("supply-chain.cta.title")}
        actions={[
            {
                variant: "primary",
                text: t("supply-chain.cta.button"),
                href: getPagePermalink("/contact", Astro.currentLocale),
                icon: "tabler:calendar"
            }
        ]}
    />
</Layout>

<style>
    .timeline-item::before {
        content: "";
        position: absolute;
        left: -2.75rem;
        top: 50%;
        transform: translateY(-50%);
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background-color: var(--aw-color-accent);
        border: 4px solid var(--aw-color-bg-page);
    }

    .chart-container {
        position: relative;
        width: 100%;
        height: 100%;
        min-height: 300px;
    }

    @media (min-width: 768px) {
        .chart-container {
            min-height: 350px;
        }
    }
</style>

<script>
    import Chart from "chart.js/auto";

    function initCharts() {
        const isDark = document.documentElement.classList.contains("dark");
        const chartTextColor = isDark ? "#CCD6F6" : "#334155";
        const chartGridColor = isDark ? "rgba(204, 214, 246, 0.1)" : "rgba(51, 65, 85, 0.1)";
        const primaryAccentColor =
            getComputedStyle(document.documentElement).getPropertyValue("--aw-color-accent").trim() || "#24BC77";
        const bgColor = isDark ? "#1e293b" : "#f8fafc";

        const processLabel = (label: string | string[]): string | string[] => {
            if (typeof label !== "string" || label.length <= 16) {
                return label;
            }
            const words = label.split(" ");
            const lines: string[] = [];
            let currentLine = "";
            for (const word of words) {
                if ((currentLine + " " + word).trim().length > 16) {
                    lines.push(currentLine.trim());
                    currentLine = word;
                } else {
                    currentLine = (currentLine + " " + word).trim();
                }
            }
            if (currentLine) {
                lines.push(currentLine.trim());
            }
            return lines;
        };

        const tooltipTitleCallback = (tooltipItems: any[]) => {
            const item = tooltipItems[0];
            let label = item.chart.data.labels[item.dataIndex];
            if (Array.isArray(label)) {
                return label.join(" ");
            } else {
                return label;
            }
        };

        const commonChartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: {
                        color: chartTextColor,
                        font: {
                            size: 14
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        title: tooltipTitleCallback
                    }
                }
            },
            scales: {
                x: {
                    ticks: { color: chartTextColor, font: { size: 12 } },
                    grid: { color: chartGridColor }
                },
                y: {
                    ticks: { color: chartTextColor, font: { size: 12 } },
                    grid: { color: chartGridColor }
                }
            }
        };

        const gartnerCtx = document.getElementById("gartnerPredictionChart") as HTMLCanvasElement;
        if (gartnerCtx) {
            new Chart(gartnerCtx, {
                type: "doughnut",
                data: {
                    labels: ["Organizations Facing Attacks", "Organizations Not (Yet) Facing Attacks"],
                    datasets: [
                        {
                            label: "% of Organizations",
                            data: [45, 55],
                            backgroundColor: [primaryAccentColor, bgColor],
                            borderColor: [chartTextColor],
                            borderWidth: 2,
                            hoverOffset: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: "bottom",
                            labels: {
                                color: chartTextColor,
                                font: { size: 14 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                title: tooltipTitleCallback
                            }
                        }
                    }
                }
            });
        }

        const attackTrendCtx = document.getElementById("attackTrendChart") as HTMLCanvasElement;
        if (attackTrendCtx) {
            new Chart(attackTrendCtx, {
                type: "line",
                data: {
                    labels: ["Early 2024", "Mid 2024", "Late 2024", "Early 2025", "Mid 2025"],
                    datasets: [
                        {
                            label: "Avg. Monthly Incidents",
                            data: [13, 15, 18, 22, 26],
                            fill: true,
                            backgroundColor: primaryAccentColor + "33",
                            borderColor: primaryAccentColor,
                            pointBackgroundColor: primaryAccentColor,
                            borderWidth: 2,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    ...commonChartOptions,
                    scales: {
                        x: {
                            title: { display: true, text: "Time Period", color: chartTextColor },
                            ticks: { color: chartTextColor },
                            grid: { color: chartGridColor }
                        },
                        y: {
                            title: { display: true, text: "Incidents per Month", color: chartTextColor },
                            beginAtZero: true,
                            ticks: { color: chartTextColor },
                            grid: { color: chartGridColor }
                        }
                    }
                }
            });
        }
    }

    // Try multiple methods to ensure DOM is ready
    if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initCharts);
    } else {
        initCharts();
    }
</script>
